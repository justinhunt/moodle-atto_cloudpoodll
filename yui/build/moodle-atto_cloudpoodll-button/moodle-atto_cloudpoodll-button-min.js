YUI.add("moodle-atto_cloudpoodll-button",function(u,e){var c="atto_cloudpoodll",p="video",i="audio",g="screen",y="widgets",A="link",h="tags",o={ENUS:"en-US",ENGB:"en-GB",ENAU:"en-AU",ENIN:"en-IN",FRCA:"fr-CA",FRFR:"fr-FR",ESUS:"es-US",ESES:"es-ES",ITIT:"it-IT",PTBR:"pt-BR",DEDE:"de-DE",KOKR:"ko-KR",HIIN:"hi-IN",ARAE:"ar-AE",ARSA:"ar-SA",ZHCN:"zh-CN",NLNL:"nl-NL",ENIE:"en-IE",ENWL:"en-WL",ENAB:"en-AB",FAIR:"fa-IR",DECH:"de-CH",HEIL:"he-IL",IDID:"id-ID",JAJP:"ja-JP",MSMY:"ms-MY",PTPT:"pt-PT",RURU:"ru-RU",TAIN:"ta-IN",TEIN:"te-IN",TRTR:"tr-TR"},_={},E="standard",v="bmr",T="onetwothree",t="screen",m={VIDEO:"atto_cloudpoodll_video",AUDIO:"atto_cloudpoodll_audio",WIDGETS:"atto_cloudpoodll_audio",UPLOAD:"atto_cloudpoodll_upload",SUBTITLE:"atto_cloudpoodll_subtitle",OPTIONS:"atto_cloudpoodll_options",HISTORY:"atto_cloudpoodll_history",SCREEN:"atto_cloudpoodll_screen",LANG_SELECT:"atto_cloudpoodll_languageselect",EXPIREDAYS_SELECT:"atto_cloudpoodll_expiredaysselect",SUBTITLE_CHECKBOX:"atto_cloudpoodll_subtitle_checkbox",MEDIAINSERT_CHECKBOX:"atto_cloudpoodll_mediainsert_checkbox",ATTO_CLOUDPOODLL_FORM:"atto_cloudpoodll_form",CP_VIDEO:"atto_cloudpoodll_video_cont",CP_SCREEN:"atto_cloudpoodll_screen_cont",CP_AUDIO:"atto_cloudpoodll_audio_cont",CP_UPLOAD:"atto_cloudpoodll_upload_cont",CP_SWAP:"atto_cloudpoodll_swapmeout",TEMPLATEVARIABLE:"atto_cloudpoodll_templatevariable"},b={subtitling:0,transcoding:!1,started:!1,currentrecorder:!1,insertmethod:!1,subitleaudiobydefault:0,subitlevideobydefault:0,elementid:!1,subtitlecheckbox:!1,filetitledisplaylength:30,showhistory:!0,showupload:!0,showoptions:!0,showexpiredays:!0,loom:!1,jws:""},l={VIDEO:'&nbsp;<video controls="true" crossorigin="anonymous"  controlsList="nodownload" preload="metadata" style="width: 100%; max-width: 800px;">{{#if includesourcetrack}}<source src="{{sourceurl}}" type="{{sourcemimetype}}">{{/if}}<source src="{{url}}" type="{{urlmimetype}}">{{#if issubtitling}}<track src="{{subtitleurl}}" kind="captions" srclang="{{CP.language}}" label="{{CP.language}}" default="true">{{/if}}</video>&nbsp;',AUDIO:'&nbsp;<audio controls="true" crossorigin="anonymous" controlsList="nodownload" preload="metadata">{{#if includesourcetrack}}<source src="{{sourceurl}}" type="{{sourcemimetype}}">{{/if}}<source src="{{url}}" type="{{urlmimetype}}">{{#if issubtitling}}<track src="{{subtitleurl}}" kind="captions" srclang="{{CP.language}}" label="{{CP.language}}" default="true">{{/if}}</audio>&nbsp;',LINK:'{{#if issubtitling}}&nbsp;<a href="{{url}}?data-subtitles={{subtitleurl}}&data-language={{CP.language}}"{{else}}&nbsp;<a href="{{url}}"{{/if}}>{{name}}</a>&nbsp;'},a='<div id="{{elementid}}_{{innerform}}" class="mdl-align"><h4 class="'+m.HEADERTEXT+'">{{headertext}}</h4></div>',n='<div id="{{elementid}}_{{innerform}}" class="atto_widget_buttons mdl-align" style="width:30%;"><button style="width: 100%;" class="'+m.NAMEBUTTON+'_{{templateindex}} btn btn-info d-block">{{name}}</button></div>',d='<div id="{{elementid}}_{{innerform}}"><span class="atto_cloudpoodll_widgetlabel">{{label}}</span>&nbsp;<input type="text" class="'+m.TEMPLATEVARIABLE+'_{{variableindex}} atto_widget_field" value="{{defaultvalue}}"></input></div>',I='<select class="'+m.TEMPLATEVARIABLE+'_{{variableindex}} atto_widget_field"></select>',s='<form class="atto_form"><div id="{{elementid}}_{{innerform}}" class="mdl-align"><button class="'+m.INPUTSUBMIT+'">{{inserttext}}</button></div></form>',r='<div id="{{elementid}}_{{innerform}}" class="mdl-align"><h4 class="'+m.HEADERTEXT+'">{{headertext}} {{key}}</h4><div class="'+m.INSTRUCTIONSTEXT+'">{{instructions}}</div></div>',f=null;u.namespace("M.atto_cloudpoodll").Button=u.Base.create("button",u.M.editor_atto.EditorPlugin,[],{initializer:function(e){var t,o;if(!e.disabled){for(t=new Array("audio","video","screen","widgets"),o=0;o<t.length;o++)e.hasOwnProperty(t[o])&&this.addButton({icon:t[o],iconComponent:"atto_cloudpoodll",title:t[o]+"_desc",buttonName:t[o],callback:this._displayDialogue,callbackArgs:t[o]});b.insertmethod=e.insertmethod,b.subtitleaudiobydefault=e.subtitleaudiobydefault,b.subtitlevideobydefault=e.subtitlevideobydefault,b.transcoding="1"==e.cp_transcode,b.filetitledisplaylength=e.filetitle_displaylength,b.showhistory="1"==e.showhistory,b.showupload="1"==e.showupload,b.showoptions="1"==e.showoptions,b.showexpiredays="1"==e.showexpiredays,b.loom=e.loom,b.jws=e.jws,_.parent=M.cfg.wwwroot,_.appid="atto_cloudpoodll",_.token=e.cp_token,_.cloudpoodllurl=e.cp_cloudpoodllurl,_.region=e.cp_region,_.owner=e.cp_owner,_.expiredays=e.cp_expiredays,_.cansubtitle=e.cp_cansubtitle,_.language=e.cp_language,_.transcode=e.cp_transcode,_.audioskin=e.cp_audioskin,_.videoskin=e.cp_videoskin,_.fallback=e.fallback,_.keys=e.keys,_.names=e.names,_.instructions=e.instructions,_.defaults=e.defaults,_.variables=e.variables,_.ends=e.ends,_.sizes=this._fetchRecorderDimensions()}},_getContext:function(e){var t={elementid:this.get("host").get("elementid"),component:c,helpStrings:this.get("help"),recorder:b.currentrecorder,CSS:m,CP:_,LANG:o};return b.currentrecorder===p&&(t.isvideo=!0),b.currentrecorder===g&&(t.isscreen=!0,b.loom&&(t.loom=!0,t.jws=b.jws,t.loomid="loom1234")),b.currentrecorder===i&&(t.isaudio=!0),1==b.subtitleaudiobydefault&&(t.letssubtitleaudio=!0),1==b.subtitlevideobydefault&&(t.letssubtitlevideo=!0),b.insertmethod===h&&(t.mediataginsert=!0),t.subtitleaudiobydefault=b.subtitleaudiobydefault,t.subtitlevideobydefault=b.subtitlevideobydefault,b.showhistory&&(t.showhistory=!0),b.showupload&&(t.showupload=!0),b.showoptions&&(t.showoptions=!0),b.showexpiredays&&(t.showexpiredays=!0),_.cansubtitle&&(t.cansubtitle=!0),_.language===o.ENUS&&(t.useENUS=!0),_.language===o.ENGB&&(t.useENGB=!0),_.language===o.ENIN&&(t.useENIN=!0),_.language===o.FRCA&&(t.useFRCA=!0),_.language===o.FRFR&&(t.useFRFR=!0),_.language===o.ESUS&&(t.useESUS=!0),_.language===o.ESES&&(t.useESES=!0),_.language===o.ITIT&&(t.useITIT=!0),_.language===o.PTBR&&(t.usePTBR=!0),_.language===o.PTPT&&(
t.usePTPT=!0),_.language===o.DEDE&&(t.useDEDE=!0),_.language===o.KOKR&&(t.useKOKR=!0),_.language===o.HIIN&&(t.useHIIN=!0),_.language===o.ARAE&&(t.useARAE=!0),_.language===o.ARSA&&(t.useARSA=!0),_.language===o.ZHCN&&(t.useZHCN=!0),_.language===o.NLNL&&(t.useNLNL=!0),_.language===o.ENIE&&(t.useENIE=!0),_.language===o.ENWL&&(t.useENWL=!0),_.language===o.ENAB&&(t.useENAB=!0),_.language===o.FAIR&&(t.useFAIR=!0),_.language===o.DECH&&(t.useDECH=!0),_.language===o.IDID&&(t.useIDID=!0),_.language===o.JAJP&&(t.useJAJP=!0),_.language===o.MSMY&&(t.useMSMY=!0),_.language===o.RURU&&(t.useRURU=!0),_.language===o.TAIN&&(t.useTAIN=!0),_.language===o.TEIN&&(t.useTEIN=!0),_.language===o.TRTR&&(t.useTRTR=!0),t["expire"+_.expiredays]=!0,u.merge(t,e)},_fetchRecorderDimensions:function(){var e={};switch(_.videoskin){case T:case t:e.videowidth=441,e.videoheight=540;break;case v:e.videowidth=441,e.videoheight=500;break;default:e.videowidth=441,e.videoheight=450}return _.audioskin,e.audiowidth=450,e.audioheight=350,e},_displayWidgetsDialogue:function(e,t){var o,i;e.preventDefault(),"800px"!==(e=this.getDialogue({headerContent:M.util.get_string("dialogtitle",c),width:"800px",focusAfterHide:t})).width&&e.set("width","800px"),o=u.Node.create("<div></div>"),i=u.Handlebars.compile(a),i=u.Node.create(i({headertext:M.util.get_string("chooseinsert",c)})),o.append(i),i=this._getButtonsForNames(t),u.Array.each(i,function(e){o.append(e)},o),e.set("bodyContent",o),e.show(),this.markUpdated()},_getButtonsForNames:function(e){var i=[];return u.Array.each(_.names,function(e,t){var o=u.Handlebars.compile(n),e=u.Node.create(o({elementid:this.get("host").get("elementid"),name:e,templateindex:t}));(this._form=e).one("."+m.NAMEBUTTON+"_"+t).on("click",this._showTemplateForm,this,t),i.push(e)},this),i},_getSubmitButtons:function(e){var t=u.Handlebars.compile(s),t=u.Node.create(t({elementid:this.get("host").get("elementid"),inserttext:M.util.get_string("insert",c)}));return t.one("."+m.INPUTSUBMIT).on("click",this._doWidgetsInsert,this,e),t},_doWidgetsInsert:function(e,t){var o,i,a,l;e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),o="{POODLL:type=",e=_.keys[t],i=_.variables[t],a=_.defaults[t],t=_.ends[t],l=a,o+='"'+e+'"',u.Array.each(i,function(e,t){t=u.one("."+m.TEMPLATEVARIABLE+"_"+t),t=t.get("value");t&&t!=l[e]&&(o+=","+e+'="'+t+'"')},this),o+="}",t&&(o+='<br/>{POODLL:type="'+e+'_end"}'),this.editor.focus(),this.get("host").insertContentAtFocusPoint(o),this.markUpdated()},_showTemplateForm:function(e,t){var o,i,a,l,n;e.preventDefault(),"800px"!==(e=this.getDialogue({headerContent:M.util.get_string("dialogtitle",c),width:"800px"})).width&&e.set("width","800px"),o=this._getTemplateFields(t),n=_.instructions[t],n=decodeURIComponent(n),a="",a=o&&0<o.length?M.util.get_string("fieldsheader",c):M.util.get_string("nofieldsheader",c),i=u.Handlebars.compile(r),a=u.Node.create(i({key:_.keys[t],headertext:a,instructions:n})),(l=u.Node.create("<div />")).append(a),u.Array.each(o,function(e){l.append(e)},l),n=this._getSubmitButtons(t),l.append(n),e.set("bodyContent",l),e.show(),this.markUpdated()},_getTemplateFields:function(e){var s=[],t=(_.keys[e],_.variables[e]),e=_.defaults[e],r=e;return u.Array.each(t,function(e,t){var o,i,a,l,n=this._makeLabel(e);e in r&&-1<r[e].indexOf("|")?(o=u.Handlebars.compile('<div id="{{elementid}}_{{innerform}}"><span class="atto_cloudpoodll_widgetlabel">{{label}}</span></div>'),o=u.Node.create(o({elementid:this.get("host").get("elementid"),label:n,variable:e,defaultvalue:r[e],variableindex:t})),l=u.Handlebars.compile(I),i=u.Node.create(l({variable:e,defaultvalue:r[e],variableindex:t})),l=r[e].split("|"),a=u.Handlebars.compile('<option value="{{option}}">{{option}}</option>'),u.Array.each(l,function(e,t){e=u.Node.create(a({option:e}));i.appendChild(e)}),o.appendChild(i)):(l=u.Handlebars.compile(d),o=u.Node.create(l({elementid:this.get("host").get("elementid"),label:n,variable:e,defaultvalue:r[e],variableindex:t}))),s.push(o)},this),s},_makeLabel:function(e){return e.split("_").map(function(e){return e.charAt(0).toUpperCase()+e.slice(1)}).join(" ")},_displayDialogue:function(e,t){var o,i,a,l,n,s,r,d;if(e.preventDefault(),(this._currentrecorder=t)!=y){switch(b.currentrecorder=t){case g:o=M.util.get_string("createscreen",c),i="502",a="660";break;case p:switch(o=M.util.get_string("createvideo",c),_.videoskin){case T:i="500",a="660";break;case E:i="500",a="580";break;case v:i="500",a="620";break;default:a=!(i="500")}break;default:o=M.util.get_string("createaudio",c),a=!(i="501")}_.cansubtitle?b.currentrecorder==p||b.currentrecorder==g?b.subtitling=b.subtitlevideobydefault:b.subtitling=b.subtitleaudiobydefault:b.subtitling=0,(l={center:!0}).headerContent=o,l.focusAfterHide=t,l.width=i+"px",a&&(l.height=a+"px"),(n=this.getDialogue(l)).get("width")!=i+"px"&&(n.set("headerContent",o),n.set("width",i+"px"),n.set("height",a+"px")),(s="")==_.token?s=M.util.get_string("notoken",c):(r=this._getContext(),d=this,require(["core/templates","core/ajax","core/log","core/notification"],function(i,e,t,a){i.render("atto_cloudpoodll/root",r).then(function(e,t){var o;s=e,e=u.Node.create(s),n.set("bodyContent",e).show(),b.elementid=d.get("host").get("elementid"),b.subtitlecheckbox=u.one("#"+b.elementid+"_"+m.SUBTITLE_CHECKBOX),b.mediainsertcheckbox=u.one("#"+b.elementid+"_"+m.MEDIAINSERT_CHECKBOX),b.languageselect=u.one("#"+b.elementid+"_"+m.LANG_SELECT),b.expiredays=u.one("#"+b.elementid+"_"+m.EXPIREDAYS_SELECT),o=u.one("#"+b.elementid+"_"+m.ATTO_CLOUDPOODLL_FORM),f=d,null!=b.subtitlecheckbox&&(_.cansubtitle?b.subtitlecheckbox.on("click",function(e){e.currentTarget.get("checked")?(o.all("."+m.CP_SWAP).setAttribute("data-transcribe","1"),o.all("."+m.CP_SWAP).setAttribute("data-subtitle","1"),o.all("."+m.CP_SWAP).setAttribute("data-alreadyparsed","false"),b.subtitling=!0):(o.all("."+m.CP_SWAP).setAttribute("data-transcribe","0"),o.all("."+m.CP_SWAP).setAttribute("data-subtitle","0"),o.all("."+m.CP_SWAP).setAttribute(
"data-alreadyparsed","false"),b.subtitling=!1),o.all("."+m.CP_SWAP).empty(),d._loadRecorders()}):this._disableSubtitleCheckbox()),null!=b.mediainsertcheckbox&&b.mediainsertcheckbox.on("click",function(e){e.currentTarget.get("checked")?b.insertmethod=h:b.insertmethod=A}),null!=b.languageselect&&b.languageselect.on("change",function(e){e=e.currentTarget;e&&(_.language=e.get("value"),o.all("."+m.CP_SWAP).setAttribute("data-language",_.language),o.all("."+m.CP_SWAP).setAttribute("data-alreadyparsed","false"),o.all("."+m.CP_SWAP).empty(),d._loadRecorders())}),null!=b.expiredays&&b.expiredays.on("change",function(e){e=e.currentTarget;e&&(_.expiredays=e.get("value"),o.all("."+m.CP_SWAP).setAttribute("data-expiredays",_.expiredays),o.all("."+m.CP_SWAP).setAttribute("data-alreadyparsed","false"),o.all("."+m.CP_SWAP).empty(),d._loadRecorders())}),d._loadRecorders(),r.loom&&(d.getDialogue({focusAfterHide:null}).hide(),i.render("atto_cloudpoodll/loomscript",r).then(function(e){var o,t=document.createElement("script");t.type="module",t.appendChild(document.createTextNode(e)),document.getElementById(r.loomid+"_script").appendChild(t),o=document.getElementById(r.loomid+"_videourl"),document.getElementById(r.loomid+"_playersource"),o.addEventListener("change",function(){var e=o.value,t=e.lastIndexOf("/"),t=e.substring(t+1),e="{POODLL:type=loom,loomid="+t+"}";d.editor.focus(),d.get("host").insertContentAtFocusPoint(e),d.markUpdated()})}).fail(function(e){a.exception(e)}))})}))}else this._displayWidgetsDialogue(e,t)},_disableSubtitleCheckbox:function(){b.subtitlecheckbox.setAttribute("disabled",!0);var e=u.one("#"+b.elementid+"_"+m.ATTO_CLOUDPOODLL_FORM);e.all("."+m.CP_SWAP).setAttribute("data-transcribe","0"),e.all("."+m.CP_SWAP).setAttribute("data-subtitle","0")},loadHistory:function(){require(["core/templates","core/ajax","core/notification"],function(o,e,t){e.call([{methodname:"atto_cloudpoodll_history_get_items",args:{recordertype:b.currentrecorder},done:function(e){Array.isArray(e.responses)&&(e.responses.forEach(function(e){var t,o,i;e.displaydateofentry=(t=e.dateofentry,o=(t=new Date(1e3*t)).getUTCMonth()+1,i=t.getUTCDate(),t=t.getUTCFullYear(),o+"/"+i+"/"+t),e.displayfiletitle=e.filetitle.substring(0,b.filetitledisplaylength)+"..."}),e.responses.formatted=JSON.stringify(e.responses));e={data:e.responses};o.render("atto_cloudpoodll/historypanel",e).then(function(e,t){o.replaceNodeContents('div[data-field="history"]',e,t)}).fail(function(e){t.exception(e)})}}])})},loadHistoryPreview:function(i){require(["core/templates","core/ajax","core/notification"],function(o,e,t){e.call([{methodname:"atto_cloudpoodll_history_get_item",args:{id:i.dataset.historyId},done:function(e){e={data:e.responses,isVideo:b.currentrecorder===p||b.currentrecorder===g};o.render("atto_cloudpoodll/historypreview",e).then(function(e,t){o.replaceNodeContents('div[data-field="history"]',e,t)}).fail(function(e){t.exception(e)})}}])})},_loadRecorders:function(){var i=this;i.uploaded=!1,i.ap_count=0,require(["atto_cloudpoodll/cloudpoodllloader"],function(o){o.init(m.CP_SWAP,function(t){switch(t.type){case"recording":"started"===t.action&&null!=b.subtitlecheckbox&&b.subtitlecheckbox.set("disabled",!0);break;case"awaitingprocessing":i.uploaded||(setTimeout(function(){var e=o.fetch_guessed_extension(b.currentrecorder),e=t.sourcefilename.split(".").slice(0,-1).join(".")+"."+e,e=t.s3root+e;i._doInsert(t.mediaurl,t.mediafilename,e,t.sourcemimetype)},4e3),i.uploaded=!0);break;case"filesubmitted":break;case"error":alert("PROBLEM:"+t.message)}})})},insertHistoryItem:function(t){f.getDialogue({focusAfterHide:null}).hide(),require(["core/ajax"],function(e){e.call([{methodname:"atto_cloudpoodll_history_get_item",args:{id:t.dataset.historyId},done:function(e){var e=e.responses[0],t=f._createMediaLink(e.mediaurl,e.mediafilename,e.sourceurl,e.sourcemimetype);b.insertmethod===h&&(t.template=f._createMediaTemplate(t.context,e.sourcemimetype,t.template)),f._insertIntoEditor(t.template,t.context)}}])})},_createMediaLink:function(e,t,o,i){var a={};return a.url=e,a.name=t,a.issubtitling=b.subtitling&&"0"!==b.subtitling,a.includesourcetrack=b.transcoding&&e!==o&&"wav"!==o.slice(-3)&&!1!==o,a.CP=_,a.subtitleurl=e+".vtt",a.sourceurl=o,a.sourcemimetype=i,{context:a,template:l.LINK}},_insertIntoEditor:function(e,t){e=u.Handlebars.compile(e)(t);this.editor.focus(),this.get("host").insertContentAtFocusPoint(e),this.markUpdated()},_createMediaTemplate:function(e,t,o){return b.currentrecorder===p||b.currentrecorder===g?(e.width=!1,e.height=!1,e.poster=!1,b.transcoding?e.urlmimetype="video/mp4":e.urlmimetype=t,l.VIDEO):(e.width=!1,e.height=!1,e.poster=!1,b.transcoding?e.urlmimetype="audio/mp3":e.urlmimetype=t,l.AUDIO)},_doInsert:function(t,o,i,a){var e,l;this.getDialogue({focusAfterHide:null}).hide(),e=(l=this._createMediaLink(t,o,i,a)).context,l=l.template,b.insertmethod===h&&(l=this._createMediaTemplate(e,a,l)),require(["core/ajax"],function(e){e.call([{methodname:"atto_cloudpoodll_history_create",args:{recordertype:b.currentrecorder,mediafilename:o,sourceurl:i,mediaurl:t,sourcemimetype:a,subtitling:b.subtitling?1:0,subtitleurl:b.subtitling?t+".vtt":""}}])}),this._insertIntoEditor(l,e)}},{ATTRS:{disabled:{value:!1}}})},"@VERSION@");