YUI.add("moodle-atto_cloudpoodll-button",function(u,e){var c="atto_cloudpoodll",p="video",a="audio",g="screen",y="widgets",A="link",h="tags",i={ENUS:"en-US",ENGB:"en-GB",ENAU:"en-AU",ENIN:"en-IN",FRCA:"fr-CA",FRFR:"fr-FR",ESUS:"es-US",ESES:"es-ES",ITIT:"it-IT",PTBR:"pt-BR",DEDE:"de-DE",KOKR:"ko-KR",HIIN:"hi-IN",ARAE:"ar-AE",ARSA:"ar-SA",ZHCN:"zh-CN",NLNL:"nl-NL",ENIE:"en-IE",ENWL:"en-WL",ENAB:"en-AB",FAIR:"fa-IR",DECH:"de-CH",HEIL:"he-IL",IDID:"id-ID",JAJP:"ja-JP",MSMY:"ms-MY",PTPT:"pt-PT",RURU:"ru-RU",TAIN:"ta-IN",TEIN:"te-IN",TRTR:"tr-TR"},_={},E="standard",v="bmr",T="onetwothree",t="screen",b={VIDEO:"atto_cloudpoodll_video",AUDIO:"atto_cloudpoodll_audio",WIDGETS:"atto_cloudpoodll_audio",UPLOAD:"atto_cloudpoodll_upload",SUBTITLE:"atto_cloudpoodll_subtitle",OPTIONS:"atto_cloudpoodll_options",HISTORY:"atto_cloudpoodll_history",SCREEN:"atto_cloudpoodll_screen",LANG_SELECT:"atto_cloudpoodll_languageselect",EXPIREDAYS_SELECT:"atto_cloudpoodll_expiredaysselect",SUBTITLE_CHECKBOX:"atto_cloudpoodll_subtitle_checkbox",MEDIAINSERT_CHECKBOX:"atto_cloudpoodll_mediainsert_checkbox",ATTO_CLOUDPOODLL_FORM:"atto_cloudpoodll_form",CP_VIDEO:"atto_cloudpoodll_video_cont",CP_SCREEN:"atto_cloudpoodll_screen_cont",CP_AUDIO:"atto_cloudpoodll_audio_cont",CP_UPLOAD:"atto_cloudpoodll_upload_cont",CP_SWAP:"atto_cloudpoodll_swapmeout",TEMPLATEVARIABLE:"atto_cloudpoodll_templatevariable"},m={subtitling:0,transcoding:!1,started:!1,currentrecorder:!1,insertmethod:!1,subitleaudiobydefault:0,subitlevideobydefault:0,elementid:!1,subtitlecheckbox:!1,filetitledisplaylength:30,showhistory:!0,showupload:!0,showoptions:!0,showexpiredays:!0},l={VIDEO:'&nbsp;<video controls="true" crossorigin="anonymous"  controlsList="nodownload" preload="metadata" style="width: 100%; max-width: 800px;">{{#if includesourcetrack}}<source src="{{sourceurl}}" type="{{sourcemimetype}}">{{/if}}<source src="{{url}}" type="{{urlmimetype}}">{{#if issubtitling}}<track src="{{subtitleurl}}" kind="captions" srclang="{{CP.language}}" label="{{CP.language}}" default="true">{{/if}}</video>&nbsp;',AUDIO:'&nbsp;<audio controls="true" crossorigin="anonymous" controlsList="nodownload" preload="metadata">{{#if includesourcetrack}}<source src="{{sourceurl}}" type="{{sourcemimetype}}">{{/if}}<source src="{{url}}" type="{{urlmimetype}}">{{#if issubtitling}}<track src="{{subtitleurl}}" kind="captions" srclang="{{CP.language}}" label="{{CP.language}}" default="true">{{/if}}</audio>&nbsp;',LINK:'{{#if issubtitling}}&nbsp;<a href="{{url}}?data-subtitles={{subtitleurl}}&data-language={{CP.language}}"{{else}}&nbsp;<a href="{{url}}"{{/if}}>{{name}}</a>&nbsp;'},o='<div id="{{elementid}}_{{innerform}}" class="mdl-align"><h4 class="'+b.HEADERTEXT+'">{{headertext}}</h4></div>',n='<div id="{{elementid}}_{{innerform}}" class="atto_widget_buttons mdl-align" style="width:30%;"><button style="width: 100%;" class="'+b.NAMEBUTTON+'_{{templateindex}} btn btn-info d-block">{{name}}</button></div>',d='<div id="{{elementid}}_{{innerform}}"><span class="atto_cloudpoodll_widgetlabel">{{label}}</span>&nbsp;<input type="text" class="'+b.TEMPLATEVARIABLE+'_{{variableindex}} atto_widget_field" value="{{defaultvalue}}"></input></div>',I='<select class="'+b.TEMPLATEVARIABLE+'_{{variableindex}} atto_widget_field"></select>',s='<form class="atto_form"><div id="{{elementid}}_{{innerform}}" class="mdl-align"><button class="'+b.INPUTSUBMIT+'">{{inserttext}}</button></div></form>',r='<div id="{{elementid}}_{{innerform}}" class="mdl-align"><h4 class="'+b.HEADERTEXT+'">{{headertext}} {{key}}</h4><div class="'+b.INSTRUCTIONSTEXT+'">{{instructions}}</div></div>',f=null;u.namespace("M.atto_cloudpoodll").Button=u.Base.create("button",u.M.editor_atto.EditorPlugin,[],{initializer:function(e){var t,i;if(!e.disabled){for(t=new Array("audio","video","screen","widgets"),i=0;i<t.length;i++)e.hasOwnProperty(t[i])&&this.addButton({icon:t[i],iconComponent:"atto_cloudpoodll",title:t[i]+"_desc",buttonName:t[i],callback:this._displayDialogue,callbackArgs:t[i]});m.insertmethod=e.insertmethod,m.subtitleaudiobydefault=e.subtitleaudiobydefault,m.subtitlevideobydefault=e.subtitlevideobydefault,m.transcoding="1"==e.cp_transcode,m.filetitledisplaylength=e.filetitle_displaylength,m.showhistory="1"==e.showhistory,m.showupload="1"==e.showupload,m.showoptions="1"==e.showoptions,m.showexpiredays="1"==e.showexpiredays,_.parent=M.cfg.wwwroot,_.appid="atto_cloudpoodll",_.token=e.cp_token,_.region=e.cp_region,_.owner=e.cp_owner,_.expiredays=e.cp_expiredays,_.cansubtitle=e.cp_cansubtitle,_.language=e.cp_language,_.transcode=e.cp_transcode,_.audioskin=e.cp_audioskin,_.videoskin=e.cp_videoskin,_.fallback=e.fallback,_.keys=e.keys,_.names=e.names,_.instructions=e.instructions,_.defaults=e.defaults,_.variables=e.variables,_.ends=e.ends,_.sizes=this._fetchRecorderDimensions()}},_getContext:function(e){var t={elementid:this.get("host").get("elementid"),component:c,helpStrings:this.get("help"),recorder:m.currentrecorder,CSS:b,CP:_,LANG:i};return m.currentrecorder===p&&(t.isvideo=!0),m.currentrecorder===g&&(t.isscreen=!0),m.currentrecorder===a&&(t.isaudio=!0),1===m.subtitleaudiobydefault&&(t.letssubtitleaudio=!0),1===m.subtitlevideobydefault&&(t.letssubtitlevideo=!0),m.insertmethod===h&&(t.mediataginsert=!0),t.subtitleaudiobydefault=m.subtitleaudiobydefault,t.subtitlevideobydefault=m.subtitlevideobydefault,m.showhistory&&(t.showhistory=!0),m.showupload&&(t.showupload=!0),m.showoptions&&(t.showoptions=!0),m.showexpiredays&&(t.showexpiredays=!0),_.cansubtitle&&(t.cansubtitle=!0),_.language===i.ENUS&&(t.useENUS=!0),_.language===i.ENGB&&(t.useENGB=!0),_.language===i.ENIN&&(t.useENIN=!0),_.language===i.FRCA&&(t.useFRCA=!0),_.language===i.FRFR&&(t.useFRFR=!0),_.language===i.ESUS&&(t.useESUS=!0),_.language===i.ESES&&(t.useESES=!0),_.language===i.ITIT&&(t.useITIT=!0),_.language===i.PTBR&&(t.usePTBR=!0),_.language===i.PTPT&&(t.usePTPT=!0),_.language===i.DEDE&&(t.useDEDE=!0),_.language===i.KOKR&&(t.useKOKR=!0),_.language===i.HIIN&&(t.useHIIN=!0),
_.language===i.ARAE&&(t.useARAE=!0),_.language===i.ARSA&&(t.useARSA=!0),_.language===i.ZHCN&&(t.useZHCN=!0),_.language===i.NLNL&&(t.useNLNL=!0),_.language===i.ENIE&&(t.useENIE=!0),_.language===i.ENWL&&(t.useENWL=!0),_.language===i.ENAB&&(t.useENAB=!0),_.language===i.FAIR&&(t.useFAIR=!0),_.language===i.DECH&&(t.useDECH=!0),_.language===i.IDID&&(t.useIDID=!0),_.language===i.JAJP&&(t.useJAJP=!0),_.language===i.MSMY&&(t.useMSMY=!0),_.language===i.RURU&&(t.useRURU=!0),_.language===i.TAIN&&(t.useTAIN=!0),_.language===i.TEIN&&(t.useTEIN=!0),_.language===i.TRTR&&(t.useTRTR=!0),t["expire"+_.expiredays]=!0,u.merge(t,e)},_fetchRecorderDimensions:function(){var e={};switch(_.videoskin){case T:case t:e.videowidth=441,e.videoheight=540;break;case v:e.videowidth=441,e.videoheight=500;break;default:e.videowidth=441,e.videoheight=450}return _.audioskin,e.audiowidth=450,e.audioheight=350,e},_displayWidgetsDialogue:function(e,t){var i,a;e.preventDefault(),"800px"!==(e=this.getDialogue({headerContent:M.util.get_string("dialogtitle",c),width:"800px",focusAfterHide:t})).width&&e.set("width","800px"),i=u.Node.create("<div></div>"),a=u.Handlebars.compile(o),a=u.Node.create(a({headertext:M.util.get_string("chooseinsert",c)})),i.append(a),a=this._getButtonsForNames(t),u.Array.each(a,function(e){i.append(e)},i),e.set("bodyContent",i),e.show(),this.markUpdated()},_getButtonsForNames:function(e){var a=[];return u.Array.each(_.names,function(e,t){var i=u.Handlebars.compile(n),e=u.Node.create(i({elementid:this.get("host").get("elementid"),name:e,templateindex:t}));(this._form=e).one("."+b.NAMEBUTTON+"_"+t).on("click",this._showTemplateForm,this,t),a.push(e)},this),a},_getSubmitButtons:function(e){var t=u.Handlebars.compile(s),t=u.Node.create(t({elementid:this.get("host").get("elementid"),inserttext:M.util.get_string("insert",c)}));return t.one("."+b.INPUTSUBMIT).on("click",this._doWidgetsInsert,this,e),t},_doWidgetsInsert:function(e,t){var i,a,o,l;e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),i="{POODLL:type=",e=_.keys[t],a=_.variables[t],o=_.defaults[t],t=_.ends[t],l=o,i+='"'+e+'"',u.Array.each(a,function(e,t){t=u.one("."+b.TEMPLATEVARIABLE+"_"+t),t=t.get("value");t&&t!=l[e]&&(i+=","+e+'="'+t+'"')},this),i+="}",t&&(i+='<br/>{POODLL:type="'+e+'_end"}'),this.editor.focus(),this.get("host").insertContentAtFocusPoint(i),this.markUpdated()},_showTemplateForm:function(e,t){var i,a,o,l,n;e.preventDefault(),"800px"!==(e=this.getDialogue({headerContent:M.util.get_string("dialogtitle",c),width:"800px"})).width&&e.set("width","800px"),i=this._getTemplateFields(t),n=_.instructions[t],n=decodeURIComponent(n),o="",o=i&&0<i.length?M.util.get_string("fieldsheader",c):M.util.get_string("nofieldsheader",c),a=u.Handlebars.compile(r),o=u.Node.create(a({key:_.keys[t],headertext:o,instructions:n})),(l=u.Node.create("<div />")).append(o),u.Array.each(i,function(e){l.append(e)},l),n=this._getSubmitButtons(t),l.append(n),e.set("bodyContent",l),e.show(),this.markUpdated()},_getTemplateFields:function(e){var s=[],t=(_.keys[e],_.variables[e]),e=_.defaults[e],r=e;return u.Array.each(t,function(e,t){var i,a,o,l,n=this._makeLabel(e);e in r&&-1<r[e].indexOf("|")?(i=u.Handlebars.compile('<div id="{{elementid}}_{{innerform}}"><span class="atto_cloudpoodll_widgetlabel">{{label}}</span></div>'),i=u.Node.create(i({elementid:this.get("host").get("elementid"),label:n,variable:e,defaultvalue:r[e],variableindex:t})),l=u.Handlebars.compile(I),a=u.Node.create(l({variable:e,defaultvalue:r[e],variableindex:t})),l=r[e].split("|"),o=u.Handlebars.compile('<option value="{{option}}">{{option}}</option>'),u.Array.each(l,function(e,t){e=u.Node.create(o({option:e}));a.appendChild(e)}),i.appendChild(a)):(l=u.Handlebars.compile(d),i=u.Node.create(l({elementid:this.get("host").get("elementid"),label:n,variable:e,defaultvalue:r[e],variableindex:t}))),s.push(i)},this),s},_makeLabel:function(e){return e.split("_").map(function(e){return e.charAt(0).toUpperCase()+e.slice(1)}).join(" ")},_displayDialogue:function(e,t){var i,a,o,l,n,s,r,d;if(e.preventDefault(),(this._currentrecorder=t)!=y){switch(m.currentrecorder=t){case g:i=M.util.get_string("createscreen",c),a="502",o="660";break;case p:switch(i=M.util.get_string("createvideo",c),_.videoskin){case T:a="500",o="660";break;case E:a="500",o="580";break;case v:a="500",o="620";break;default:o=!(a="500")}break;default:i=M.util.get_string("createaudio",c),o=!(a="501")}_.cansubtitle?m.currentrecorder==p||m.currentrecorder==g?m.subtitling=m.subtitlevideobydefault:m.subtitling=m.subtitleaudiobydefault:m.subtitling=0,(l={center:!0}).headerContent=i,l.focusAfterHide=t,l.width=a+"px",o&&(l.height=o+"px"),(n=this.getDialogue(l)).get("width")!=a+"px"&&(n.set("headerContent",i),n.set("width",a+"px"),n.set("height",o+"px")),(s="")==_.token?s=M.util.get_string("notoken",c):(r=this._getContext(),d=this,require(["core/templates","core/ajax","core/notification"],function(e,t,i){e.render("atto_cloudpoodll/root",r).then(function(e,t){var i;s=e,e=u.Node.create(s),n.set("bodyContent",e).show(),m.elementid=d.get("host").get("elementid"),m.subtitlecheckbox=u.one("#"+m.elementid+"_"+b.SUBTITLE_CHECKBOX),m.mediainsertcheckbox=u.one("#"+m.elementid+"_"+b.MEDIAINSERT_CHECKBOX),m.languageselect=u.one("#"+m.elementid+"_"+b.LANG_SELECT),m.expiredays=u.one("#"+m.elementid+"_"+b.EXPIREDAYS_SELECT),i=u.one("#"+m.elementid+"_"+b.ATTO_CLOUDPOODLL_FORM),f=d,null!=m.subtitlecheckbox&&(_.cansubtitle?m.subtitlecheckbox.on("click",function(e){e.currentTarget.get("checked")?(i.all("."+b.CP_SWAP).setAttribute("data-transcribe","1"),i.all("."+b.CP_SWAP).setAttribute("data-subtitle","1"),i.all("."+b.CP_SWAP).setAttribute("data-alreadyparsed","false"),m.subtitling=!0):(i.all("."+b.CP_SWAP).setAttribute("data-transcribe","0"),i.all("."+b.CP_SWAP).setAttribute("data-subtitle","0"),i.all("."+b.CP_SWAP).setAttribute("data-alreadyparsed","false"),m.subtitling=!1),i.all("."+b.CP_SWAP).empty(),d._loadRecorders()}):this._disableSubtitleCheckbox()),
null!=m.mediainsertcheckbox&&m.mediainsertcheckbox.on("click",function(e){e.currentTarget.get("checked")?m.insertmethod=h:m.insertmethod=A}),null!=m.languageselect&&m.languageselect.on("change",function(e){e=e.currentTarget;e&&(_.language=e.get("value"),i.all("."+b.CP_SWAP).setAttribute("data-language",_.language),i.all("."+b.CP_SWAP).setAttribute("data-alreadyparsed","false"),i.all("."+b.CP_SWAP).empty(),d._loadRecorders())}),null!=m.expiredays&&m.expiredays.on("change",function(e){e=e.currentTarget;e&&(_.expiredays=e.get("value"),i.all("."+b.CP_SWAP).setAttribute("data-expiredays",_.expiredays),i.all("."+b.CP_SWAP).setAttribute("data-alreadyparsed","false"),i.all("."+b.CP_SWAP).empty(),d._loadRecorders())}),d._loadRecorders()}).fail(function(e){i.exception(e)})}))}else this._displayWidgetsDialogue(e,t)},_disableSubtitleCheckbox:function(){m.subtitlecheckbox.setAttribute("disabled",!0);var e=u.one("#"+m.elementid+"_"+b.ATTO_CLOUDPOODLL_FORM);e.all("."+b.CP_SWAP).setAttribute("data-transcribe","0"),e.all("."+b.CP_SWAP).setAttribute("data-subtitle","0")},loadHistory:function(){require(["core/templates","core/ajax","core/notification"],function(i,e,t){e.call([{methodname:"atto_cloudpoodll_history_get_items",args:{recordertype:m.currentrecorder},done:function(e){Array.isArray(e.responses)&&(e.responses.forEach(function(e){var t,i,a;e.displaydateofentry=(t=e.dateofentry,i=(t=new Date(1e3*t)).getUTCMonth()+1,a=t.getUTCDate(),t=t.getUTCFullYear(),i+"/"+a+"/"+t),e.displayfiletitle=e.filetitle.substring(0,m.filetitledisplaylength)+"..."}),e.responses.formatted=JSON.stringify(e.responses));e={data:e.responses};i.render("atto_cloudpoodll/historypanel",e).then(function(e,t){i.replaceNodeContents('div[data-field="history"]',e,t)}).fail(function(e){t.exception(e)})}}])})},loadHistoryPreview:function(a){require(["core/templates","core/ajax","core/notification"],function(i,e,t){e.call([{methodname:"atto_cloudpoodll_history_get_item",args:{id:a.dataset.historyId},done:function(e){e={data:e.responses,isVideo:m.currentrecorder===p||m.currentrecorder===g};i.render("atto_cloudpoodll/historypreview",e).then(function(e,t){i.replaceNodeContents('div[data-field="history"]',e,t)}).fail(function(e){t.exception(e)})}}])})},_loadRecorders:function(){var a=this;a.uploaded=!1,a.ap_count=0,require(["atto_cloudpoodll/cloudpoodllloader"],function(i){i.init(b.CP_SWAP,function(t){switch(t.type){case"recording":"started"===t.action&&null!=m.subtitlecheckbox&&m.subtitlecheckbox.set("disabled",!0);break;case"awaitingprocessing":a.uploaded||(setTimeout(function(){var e=i.fetch_guessed_extension(m.currentrecorder),e=t.sourcefilename.split(".").slice(0,-1).join(".")+"."+e,e=t.s3root+e;a._doInsert(t.mediaurl,t.mediafilename,e,t.sourcemimetype)},4e3),a.uploaded=!0);break;case"filesubmitted":break;case"error":alert("PROBLEM:"+t.message)}})})},insertHistoryItem:function(t){f.getDialogue({focusAfterHide:null}).hide(),require(["core/ajax"],function(e){e.call([{methodname:"atto_cloudpoodll_history_get_item",args:{id:t.dataset.historyId},done:function(e){var e=e.responses[0],t=f._createMediaLink(e.mediaurl,e.mediafilename,e.sourceurl,e.sourcemimetype);m.insertmethod===h&&(t.template=f._createMediaTemplate(t.context,e.sourcemimetype,t.template)),f._insertIntoEditor(t.template,t.context)}}])})},_createMediaLink:function(e,t,i,a){var o={};return o.url=e,o.name=t,o.issubtitling=m.subtitling&&"0"!==m.subtitling,o.includesourcetrack=m.transcoding&&e!==i&&"wav"!==i.slice(-3)&&!1!==i,o.CP=_,o.subtitleurl=e+".vtt",o.sourceurl=i,o.sourcemimetype=a,{context:o,template:l.LINK}},_insertIntoEditor:function(e,t){e=u.Handlebars.compile(e)(t);this.editor.focus(),this.get("host").insertContentAtFocusPoint(e),this.markUpdated()},_createMediaTemplate:function(e,t,i){return m.currentrecorder===p||m.currentrecorder===g?(e.width=!1,e.height=!1,e.poster=!1,m.transcoding?e.urlmimetype="video/mp4":e.urlmimetype=t,l.VIDEO):(e.width=!1,e.height=!1,e.poster=!1,m.transcoding?e.urlmimetype="audio/mp3":e.urlmimetype=t,l.AUDIO)},_doInsert:function(t,i,a,o){var e,l;this.getDialogue({focusAfterHide:null}).hide(),e=(l=this._createMediaLink(t,i,a,o)).context,l=l.template,m.insertmethod===h&&(l=this._createMediaTemplate(e,o,l)),require(["core/ajax"],function(e){e.call([{methodname:"atto_cloudpoodll_history_create",args:{recordertype:m.currentrecorder,mediafilename:i,sourceurl:a,mediaurl:t,sourcemimetype:o,subtitling:m.subtitling?1:0,subtitleurl:m.subtitling?t+".vtt":""}}])}),this._insertIntoEditor(l,e)}},{ATTRS:{disabled:{value:!1}}})},"@VERSION@");